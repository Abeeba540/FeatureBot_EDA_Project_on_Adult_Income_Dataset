name: Reproducibility Tests

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  reproducibility:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.10']

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas numpy scikit-learn joblib
    
    - name: Run reproducibility test (Run 1)
      run: |
        echo "=========================================="
        echo "REPRODUCIBILITY TEST - RUN 1"
        echo "=========================================="
        python train_model.py > run1.txt 2>&1
        echo "✅ Run 1 complete"
    
    - name: Run reproducibility test (Run 2)
      run: |
        echo "=========================================="
        echo "REPRODUCIBILITY TEST - RUN 2"
        echo "=========================================="
        python train_model.py > run2.txt 2>&1
        echo "✅ Run 2 complete"
    
    - name: Compare results
      run: |
        echo "=========================================="
        echo "COMPARING OUTPUTS"
        echo "=========================================="
        if grep -q "Test AUC:  0.9075" run1.txt && grep -q "Test AUC:  0.9075" run2.txt; then
          echo "✅ Test AUC IDENTICAL across runs"
        else
          echo "❌ Test AUC DIFFERS"
          grep "Test AUC:" run1.txt
          grep "Test AUC:" run2.txt
          exit 1
        fi
        
        if grep -q "Test F1: 0.6802" run1.txt && grep -q "Test F1: 0.6802" run2.txt; then
          echo "✅ Test F1 IDENTICAL across runs"
        else
          echo "❌ Test F1 DIFFERS"
          grep "Test F1:" run1.txt
          grep "Test F1:" run2.txt
          exit 1
        fi
    
    - name: Final status
      if: success()
      run: |
        echo "=========================================="
        echo "✅ ALL REPRODUCIBILITY CHECKS PASSED!"
        echo "=========================================="
        echo "Run 1 metrics:"
        grep -E "Test AUC|Test F1" run1.txt
        echo ""
        echo "Run 2 metrics:"
        grep -E "Test AUC|Test F1" run2.txt
