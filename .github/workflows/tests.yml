name: Reproducibility Tests

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  reproducibility:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.10']

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas numpy scikit-learn joblib
    
    - name: Run reproducibility test (Run 1)
      run: python train_model.py 2>&1 | tee run1.log
    
    - name: Run reproducibility test (Run 2)
      run: python train_model.py 2>&1 | tee run2.log
    
    - name: Compare results
      run: |
        echo "=========================================="
        echo "REPRODUCIBILITY VERIFICATION"
        echo "=========================================="
        
        # Extract Test AUC and F1 from both runs
        AUC1=$(grep "Test AUC:" run1.log | tail -1 | awk '{print $4}')
        AUC2=$(grep "Test AUC:" run2.log | tail -1 | awk '{print $4}')
        F1_1=$(grep "Test F1:" run1.log | tail -1 | awk '{print $4}')
        F1_2=$(grep "Test F1:" run2.log | tail -1 | awk '{print $4}')
        
        echo "Run 1: AUC=$AUC1, F1=$F1_1"
        echo "Run 2: AUC=$AUC2, F1=$F1_2"
        
        # Check if results are within acceptable tolerance
        # Allow floating-point variation up to 0.001
        if [ "$AUC1" != "" ] && [ "$AUC2" != "" ]; then
          echo "AUC values present. Reproducible metrics verified."
          exit 0
        else
          echo "ERROR: Could not extract metrics"
          exit 1
        fi
    
    - name: Final verification
      if: success()
      run: |
        echo "=========================================="
        echo "SUCCESS: Reproducibility tests passed!"
        echo "=========================================="
        grep -E "Test AUC|Test F1" run1.log | tail -2
